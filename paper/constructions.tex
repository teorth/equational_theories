
\section{Counterexample constructions}

In this section we collect the various techniques developed in the ETP to construct counterexamples to various implications $\E \models {\E'}$.

\subsection{Finite magmas}\label{finite-sec}

A finite magma $\Magma$ of size $n$ can be assumed without loss of generality to have carrier $\{1,\dots,n\}$ and described by specifying the multiplication table $\op \colon \{1,\dots,n\} \times \{1,\dots,n\} \to \{1,\dots,n\}$.  By generating a list of all the equational laws $\Eq{j}$, $j=1,\dots,4694$ satisfied by this magma, one can create refutations: if $\Magma \models \Eq{j}$ and $\Magma \not \models \Eq{k}$, then clearly $\Eq{j} \nmodelsfin \Eq{k}$ and hence also $\Eq{j} \nmodels \Eq{k}$.  (As mentioned previously, these statements were organized in Lean using the \texttt{Facts} statement.) It is feasible to brute force over all $\sum_{n=2}^4 n^{n^2} \approx 4.3 \times 10^9$ non-trivial magmas of size at most $4$ to obtain many refutations of this type.
By performing brute force over all magmas up to size $4$, a total of $\num{13632566}$ implications ($61.9\%$ of all implications, and $96.3\%$ of the false ones) can be refuted with $524$ distinct magmas. Of these implications, $\num{13345053}$ were refuted with magmas of size\footnote{For an earlier computer exploration of size $3$ magmas, see \cite{berman-burris}.} $3$, with the remaining $\num{415293}$ requiring magmas of size $4$. Performing this search took 165 CPU-hours.

However, it is not feasible to exhaustively search over the $5^{5^2} \approx 3 \times 10^{17}$ magmas of size $5$, even after quotienting out by isomorphism and symmetry (which roughly saves a factor of $5! \times 2 = 240$).  Randomly sampling such magmas did not produce significant refutations, as random magmas of size $5$ tended to satisfy few laws, and the set of laws covered were usually also exhibited by smaller magmas.  A more fruitful approach was to randomly sample from magmas with additional properties that encouraged satisfiability of a greater set of laws.  These included linear and quadratic magmas (discussed below), and cancellative magmas.  On the other hand, some classes of magmas, such as commutative magmas, ended up producing a disappointingly small number of additional refutations.

For specific refutations, it was sometimes possible to locate a finite example with an ATP, particularly if one also imposed additional axioms (e.g., an idempotence axiom $x = x \op x$) that one suspected would be useful; see \Cref{automated-sec} for further discussion.  For medium-sized magmas (of size $n=5,6,7,8$), this appeared to be a more efficient approach than brute force exhaustion of all such magmas.

It is a result of Kisielewicz \cite{Kisielewicz} that every law $\Eq{n}$ with $n \leq 4694$ is either equivalent to the singleton law $\Eq{2}$, or else has a non-trivial finite model; in other words, the implications $\Eq{n} \models \Eq{2}$ and $\Eq{n} \modelsfin \Eq{2}$ are equivalent for $n \leq 4694$.  Our brute force search revealed that in the latter case there is always a model of size $2 \leq n \leq 5$, with the lone exception of $\Eq{1286}$ (and its dual $\Eq{2301}$), for which the smallest non-trivial finite model was of size $7$, as presented in \Cref{1286-ex} below.  In fact, most of the $\num{4694}$ laws either only had trivial models, or had a size $2$ model, as shown in \Cref{size-table}.
\begin{table}
\centering
\caption{Number of laws of order at most $4$ whose smallest non-trivial model (if any) is of a given size.}\label{size-table}
\begin{tabular}{ll}
  \hline
Size of smallest non-trivial model & Number of laws \\
\hline
Trivial only & $1496$ \\
$2$ & $3136$ \\
$3$ & $32$ \\
$4$ & $14$ \\
$5$ & $14$ \\
$7$ & $2$\\
\hline
\end{tabular}
\end{table}

\begin{remark} The laws satisfied by a given finite magma $\Magma$ need not be finitely axiomatizable.  The smallest example is the three-element magma $\{0,1,2\}$ with $1 \op 2 = 1$, $2 \op 1 = 2 \op 2 = 2$, and $x \op y = 0$ for all other $x,y$ \cite{murskii-1}.  It was also shown in \cite{murskii-2} that ``almost all'' magmas $\Magma$ (in a certain precise sense) are idemprimal\footnote{A magma is idemprimal if every idempotent function is expressed by a term.  This is weaker than being primal (in which \emph{every} function is expressible by a term), but stronger than being quasiprimal (in which the \emph{discriminator} $f(a,b,c)$, defined to equal $c$ if $a=b$ and $a$ otherwise, is expressed by a term); quasiprimality is sufficient to show that all other finite magmas satisfying the laws of $\Magma$ are isomorphic to products of submagmas of $\Magma$.  By combining these observations with \cite{Padmanabhan}, one can also show that quasiprimal finite magmas can be axiomatized by a single equation.  We thank Stanley Burris for these comments, as well as the other references and observations in this remark.}, which implies that their laws are finitely axiomatizable, and all other finite magmas satisfying these laws are isomorphic to powers of $\Magma$.
\end{remark}

\subsection{Linear models}\label{linear-sec}

As it turns out, a particularly fruitful source of counterexamples is the class of \emph{linear magmas}, where the carrier $M$ is a ring (which may be commutative or noncommutative, finite or infinite), and the operation $\op$ is given by $x \op y = ax + by$ for some coefficients $a,b \in M$; one can also generalize this slightly to \emph{affine magmas}, in which the operation is given by $x \op y = ax + by + c$, but for simplicity we shall focus on linear magmas here.  It is easy to see that in a linear magma, any word $w(x_1,\dots,x_n)$ of $n$ indeterminates also takes the linear form
$$ w(x_1,\dots,x_n) = \sum_{i=1}^n P_{w,i}(a,b) x_i$$
for some (possibly noncommutative) polynomial $P_{w,i}$ in $a,b$ with integer coefficients.  Thus, a linear magma will satisfy an equational law $w_1 \formaleq w_2$ if and only if the pair $(a,b)$ lies in the (possibly noncommutative) variety
\begin{equation}\label{variety}
  V_{w_1,w_2}(M) \coloneqq \{ (a,b) \in M \times M: P_{w_1,i}(a,b) = P_{w_2,i}(a,b) \hbox{ for all } i \} \subseteq M^2.
\end{equation}
As such, a necessary condition for such a law $w_1 \formaleq w_2$ to entail another law $w'_1 \formaleq w'_2$ is that one has the inclusion
$$ V_{w_1,w_2}(M) \subseteq V_{w'_1,w'_2}(M)
$$
for all rings $M$.  For commutative rings, this criterion can be checked in an automatable fashion by standard Gr\"obner basis techniques; in the noncommutative case one can use methods such as the diamond lemma \cite{diamond-lemma}.

\begin{example}[Commutative counterexample]\label{1286-ex} For the law $x \formaleq y \op (((x \op y) \op x) \op y)$ \eqref{eq1286}, the variety \eqref{variety} can be computed to be
$$ \{ (a,b) \in M \times M: 1 = ba^3+bab, 0 = a + ba^2 b + b^2 \}$$
while the variety for the idempotent law $\Eq{3}$ is
$$ \{ (a,b) \in M: a+b=1 \}.$$
Thus, to show that $\Eq{1286}$ does not entail $\Eq{3}$, it suffices to locate elements $a,b$ of a ring $M$ for which one has $1 = ba^3+bab$, $0 = a + ba^2 b + b^2$, and $a+b \neq 1$.  Here one can take a commutative example, for instance when $M = \Z/p\Z$ and $(p,a,b) = (11,1,7)$.
\end{example}

\begin{example}[Noncommutative counterexample]\label{1117-ex} For the law $x \formaleq y \op ((y \op (x \op z)) \op z)$ \eqref{eq1117}, the variety \eqref{variety} can be computed to be
$$ \{ (a,b) \in M \times M: 1 = baba, 0 = a+ba^2, 0 = bab^2 + b^2 \}$$
while the variety for $x \formaleq (x \op ((x \op x) \op x)) \op x$ \eqref{eq2441} is
$$ \{ (a,b) \in M \times M: 1 = a^2 + aba^2 + abab + ab^2 + b \}.$$
Observe that if $ba = -1$, then $(a,b)$ automatically lies in the first set, and lies in the second set if and only if $(ab+1)(b-1) = 0$.  One can then show that $\Eq{1117}$ does not imply $\Eq{2441}$ by setting $a = L$, $b = -R$ where $L, R$ are the left and right shift operators respectively on the ring of integer-valued sequences $\Z^\N$.  With some \emph{ad hoc} effort one can convert this example into a less linear, but simpler (and easier to formalize) example, namely the magma with carrier $\Z$ and operation $x \op y = 2x - \lfloor y/2 \rfloor$.
\end{example}

\begin{remark} As essentially observed in \cite{austin}, if there is a commutative linear counterexample to an implication $\E \models {\E'}$, then by the Lefschetz principle this counterexample can be realized in a finite field ${\mathbb F}_q$ for some prime power $q$ (and by the Chebotarev density theorem one can in fact take $q$ to be a prime, so that the carrier is of the form $\Z/p\Z$ for some prime $p$), so that one also has $\E \modelsfin {\E'}$.  As such, we have found that an effective way to refute implications by the commutative linear magma method is to simply perform a brute force search over linear magmas $x \op y = ax + by$ in $\Z/p\Z$ for various triples $(p,a,b)$.

On the other hand, the refutations obtained by noncommutative linear constructions need not have a finite model.  For instance, consider the refutation $\Eq{1117} \nmodels \Eq{2441}$ from \Cref{1117-ex}.  The law $\Eq{1117}$ can be rewritten as $L_y R_z L_y R_z x = x$.  This implies that $R_z$ is injective and $L_y$ is surjective for all $y,z$.  For finite magmas $\Magma$, this then implies that the $L_y, R_z$ are in fact invertible, and hence we have also $R_z L_y R_z L_y x = x$, which implies $\Eq{2441}$ by setting $x=y=z$.  Thus, the refutation $\Eq{1117} \nmodels \Eq{2441}$ is ``immune'' to finite counterexamples.
\end{remark}

\begin{remark}  One can also consider nonlinear magma models, such as quadratic models $x \op y = ax^2 + bxy + cy^2 + dx + ey + f$ in a cyclic group $\Z/N\Z$.  For small values of $N$, we have found such models somewhat useful in providing additional refutations of implications $\E \modelsfin {\E'}$ beyond what can be achieved by the linear or affine models.  However, as the polynomials associated to a word $w(x_1,\dots,x_n)$ tend to be of high degree (exponential in the order of the word), it becomes quite rare for such models to satisfy a given equation $\E$ when $N$ is large.
\end{remark}

\begin{remark} One can also consider the seemingly more general linear model $x \op y = ax + by$, where the carrier $M$ is now an abelian group, and $a,b$ act on $M$ by homomorphisms, that is to say that they are elements of the endomorphism ring $\mathrm{End}(M)$.  However, this leads to exactly the same varieties \eqref{variety} (where $M$ is now replaced by the endomorphism ring $\mathrm{End}(M)$) and so does not increase the power of the linear model for the purposes of refuting implications.
\end{remark}

On the other hand, there are certainly some refutations $\E \nmodels {\E'}$ of implications that are ``immune'' to both commutative and noncommutative linear models, in the sense that all such models that satisfy $\E$, also satisfy ${\E'}$.  One such example is the refutation $\Eq{1485} \not \models \Eq{151}$, which we discuss further in \Cref{twisting-sec} below.

\subsection{Translation-invariant models}\label{translation-sec}

It is natural to look for counterexamples amongst magmas that satisfy a large number of symmetries.  One such class of counterexamples are \emph{translation-invariant models}, in which the carrier $M$ is a group, and the left translations of this group form isomorphisms of the magma $\Magma$.  In the case of an abelian group $M = (M,+)$, such models take the form
\begin{equation}\label{xop-add}
  x \op y = x + f(y-x)
\end{equation}
for some function $f \colon M \to M$; in the case of a non-abelian group $M = (M,\cdot)$, such models instead take the form
\begin{equation}\label{xop-mul}
x \op y = x f(x^{-1} y).
\end{equation}
For such models, the verification of an equational law in $n$ variables corresponds to a functional equation for $f$ in $n-1$ variables, as the translation symmetry allows one to normalize one variable to be the identity (say). This can simplify an implication to the point where an explicit counterexample can be found.  These functional equations are trivial to analyze when $n=1$.  For $n=2$, they are not as trivial, but still quite tractable, and has led to several refutations in practice.  The method does not appear to be particularly effective for $n>2$ due to the complexity of the functional equations.

\begin{example}[Abelian example]\label{abex}  For the law $\x \formaleq (\x \op \y) \op ((\x \op \y) \op \y)$ \eqref{eq1648}, we apply the abelian translation-invariant model \eqref{xop-add} with $y=x+h$ to obtain
\begin{align*}
  x \op y &= x + f(h) \\
  (x \op y) \op y &= x + f(h) + f(h-f(h)) \\
  (x \op y) \op ((x \op y) \op y) &= x + f(h) + f(f(h-f(h)))
\end{align*}
so that this model satisfies $\Eq{1648}$ if and only if the functional equation
$$f(h) + f(f(h-f(h))) = 0$$
holds for all $h \in M$.  Similarly, the law $\x \formaleq (\x \op (\x \op \y)) \op \y$ \eqref{eq206} is satisfied if and only if
$$ f(f(h)) + f(h - f(f(h))) = 0$$
for all $h \in M$.  One can now check that the function $f \colon \Z \to \Z$ defined by $f(h) \coloneqq - \mathrm{sgn}(h)$ (thus $f(h)$ equals $-1$ when $h$ is positive, $+1$ when $h$ is negative, and $0$ when $h$ is zero) satisfies the first functional equation but not the second, thus establishing that $\Eq{1648} \nmodels \Eq{206}$.
\end{example}

\begin{example}[Non-abelian example]\label{trans-nonab}  We now obtain the opposite refutation $\Eq{206} \nmodels \Eq{1648}$ to \Cref{abex} using the non-abelian translation-invariant model.  By similar calculations to before, we now seek to find a function $f \colon M \to M$ on a non-abelian group $(M,\cdot)$ that satisfies the functional equation
\begin{equation}\label{206-eq}
 f(f(h)) f(f(f(h))^{-1} h) = 1
\end{equation}
for all $h \in M$, but fails to satisfy the functional equation
\begin{equation}\label{1648-eq}
   f(h) f(f(f(h)^{-1} h)) = 1
\end{equation}
for at least one $h \in M$.  Now take $M$ to be the group generated by three generators $a,b,c$ subject to the relations $a^2=b^2=c^2=1$, or equivalently the group of reduced words in $a,b,c$ with no adjacent letters in the word equal.  We define
$$ f(1) = 1, f(a)=b, f(b) = c, f(c) = a$$
and then $f(aw)=a$ for any non-empty reduced word $w$ not starting with $a$, and similarly for $b$ and $c$.  The equation \eqref{206-eq} can be checked directly for $h=1,a,b,c$.  If $h=aw$ with $w$ non-empty, reduced, and not starting with $a$, then $f(f(h))^{-1} = f(f(h)) = b$ and $f(f(f(h))^{-1} h) = f(baw) = b$, giving \eqref{206-eq} in this case, and similarly for cyclic permutations. Meanwhile, \eqref{1648-eq} can be checked to fail for $h=a$.
\end{example}

\begin{remark}  The construction in \Cref{trans-nonab} also has the following more ``geometric'' interpretation.  The carrier $M$ can be viewed as the infinite $3$-regular tree, in which every vertex imposes a cyclic ordering on its $3$ neighbors (for instance, if we embed $M$ as a planar graph, we can use the clockwise ordering).  For $x,y \in M$, we then define $x \op y$ to equal $x$ if $x=y$.  If $y$ is instead a neighbor of $x$, we define $x \op y$ to be the next neighbor of $x$ in the cyclic ordering.  Finally, if $y$ is distance two or more from $x$, we define $x \op y$ to be the neighbor of $x$ that is closest to $y$.  One can then check that this model satisfies \eqref{206-eq} but not \eqref{1648-eq}.
\end{remark}

\begin{remark} These constructions are necessarily infinitary in nature, because $\Eq{206}$ and $\Eq{1648}$ can be shown to be equivalent for finite magmas. Indeed, $\Eq{206}$ can be written as $x = R_y L_x L_x y$, which implies that $R_y$ is surjective, hence injective, on a finite magma; writing $x = R_y z$ we conclude that $R_y z = R_y L_{z \op y} L_{z \op y} y$ and hence $z = L_{z \op y} L_{z \op y} y$, giving $\Eq{1648}$.  The opposite implication is similar (using $\Eq{1648}$ to show that $R_y$ is injective, hence surjective), and is left to the reader.
\end{remark}

  Some refutations $\E \nmodels {\E'}$ are ``immune'' to translation-invariant models, in the sense that any translation-invariant model that satisfies $\E$, also satisfies ${\E'}$.  One obstruction is that for such models, the squaring map $S$ is necessarily an invertible map, since $Sx = x + f(0)$ in the abelian case and $Sx = xf(1)$ in the non-abelian case. On the other hand, adding the assumption of invertibility of squares can sometimes force the implication $\E \models {\E'}$ to hold.  For instance, the commutative law $\x \op (\y \op \y) \formaleq (\y \op \y) \op \x$ \eqref{eq4482} for a square and an arbitrary element will imply the full commutative law $\Eq{43}$ for translation-invariant models due to the surjectivity of $S$, but does not imply it in general (as one can easily see by considering models where $S$ is constant).

\subsection{The twisting semigroup}\label{twisting-sec}

Suppose one has a magma $\Magma$ satisfying a law $\E$, that also enjoys some endomorphisms $T, U \colon \Magma \to \Magma$.  Then one can ``twist'' the operation $\op$ by $T,U$ to obtain a new magma operation
\begin{equation}\label{twist} x \op' y := Tx \op Uy.
\end{equation}
If one then tests whether this new operation $\op'$ satisfies the same law $\E$ as the original operation $\op$, one will find that this will be the case provided that $T,U$ satisfy a certain set of relations.  The semigroup generated by formal generators $\mathrm{T}, \mathrm{U}$ with these relations will be called the \emph{twisting semigroup} $\operatorname{Twist}_\E$ of $\E$.  This can be best illustrated with some examples.

\begin{example}  We compute the twisting semigroup of $\x \formaleq (\y \op \x) \op (\x \op (\z \op \y))$ \eqref{eq1485}.  We test this law on the operation \eqref{twist}, thus we consider whether
$$x = (y \op' x) \op' (x \op' (z \op' y))$$
holds for all $x,y,z \in M$.  Substituting in \eqref{twist} and using the homomorphism property repeatedly, this reduces to
$$x = (T^2y \op TUx) \op (UTx \op (U^2T z \op U^3y)).$$
If we impose the conditions $TU=UT=\mathrm{id}$, $T^2 = U^3$, then this equation would follow from $\Eq{1485}$ (with $x,y,z$ replaced with $TUx=UTx=x$, $T^2 y$, and $U^2 Tz$ respectively).  Thus the twisting semigroup $\operatorname{Twist}_{\Eq{1485}}$ of $\Eq{1485}$ is generated by two generators $\mathrm{T}, \mathrm{U}$ subject to the relations $\mathrm{T} \mathrm{U}=\mathrm{U} \mathrm{T} = 1$, $\mathrm{T}^2 = \mathrm{U}^3$.  This is a cyclic group of order $5$, since the relations can be rewritten as $\mathrm{T}^5 = 1$, $\mathrm{U} = \mathrm{T}^{-1}$.

Now consider $\x \formaleq (\x \op \x) \op (\x \op \x)$ \eqref{eq151}.  Applying the same procedure, we arrive at
$$x = (T^2 x \op TUx) \op (UT x \op U^2 x)$$
so the twisting group $\operatorname{Twist}_{\Eq{151}}$ is generated by two generators $\mathrm{T}, \mathrm{U}$ subject to the relations $\mathrm{T} \mathrm{U}=\mathrm{U} \mathrm{T} = \mathrm{T}^2 = \mathrm{U}^2 = 1$.  This is a cyclic group of order $2$, since the relations can be rewritten as $\mathrm{T}^2 = 1$, $\mathrm{U} = \mathrm{T}$.
\end{example}

Suppose the twisting semigroup $\operatorname{Twist}_\E$ is not a quotient of $\operatorname{Twist}_{{\E'}}$, in the sense that the relations that define $\operatorname{Twist}_{{\E'}}$ are not satisfied by the generators of $\operatorname{Twist}_\E$.  Then one can often disprove the implication $\E \models {\E'}$ by attempting the following procedure.
\begin{itemize}
\item First, locate a non-trivial magma $\Magma = (M,\op)$ satisfying the law $\E$.  Then the Cartesian power $M^{\operatorname{Twist}_\E}$ of tuples $(x_W)_{W \in \operatorname{Twist}_\E}$, with the pointwise magma operation, will also satisfy $\E$.
\item Furthermore, this Cartesian power admits two endomorphisms $T, U$ defined by
$$ T (x_W)_{W \in \operatorname{Twist}_\E} = (x_{W \mathrm{T}})_{W \in \operatorname{Twist}_\E};
U (x_W)_{W \in \operatorname{Twist}_\E} = (x_{W \mathrm{U}})_{W \in \operatorname{Twist}_\E},$$
which satisfy the relations defining $\operatorname{Twist}_\E$.
\item We now twist the magma operation $\op$ on $M^{\operatorname{Twist}_\E}$ by $T,U$ to obtain a new magma operation $\op'$ defined by \eqref{twist}, that will still satisfy law $\E$.
\item Because $T, U$ will not satisfy the relations defining $\operatorname{Twist}_{{\E'}}$, it is highly likely that this twisted operation will not satisfy ${\E'}$, thus refuting the implication $\E \models {\E'}$.  If $M$ and the twisting semigroup were finite, this approach should also refute $\E \modelsfin {\E'}$.
\end{itemize}

For instance, a non-trivial finite model for $\Eq{1485}$ is given by the finite field $\mathbb{F}_2$ of two elements with the NAND operation $x \op y \coloneqq 1-xy$.  If we twist $\mathbb{F}_2^5$ by the left shift $T(x_i)_{i=1}^5 = (x_{i+1})_{i=1}^5$ and right shift $U(x_i)_{i=1}^5 = (x_{i-1})_{i=1}^5$, where we extend the indices periodically modulo $5$, then the resulting operation
$$ (x_i)_{i=1}^5 \op' (y_i)_{i=1}^5 \coloneqq (1 - x_{i+1} y_{i-1})_{i=1}^5$$
on $\mathbb{F}_2^5$ still satisfies $\Eq{1485}$, but does not satisfy $\Eq{151}$, thus showing that $\Eq{1485} \nmodelsfin \Eq{151}$ and hence $\Eq{1485} \nmodels \Eq{151}$.  This particular implication does not seem to be easily refuted by any of the other methods discussed in this paper.

\subsection{Greedy constructions}\label{greedy-sec}

We have found \emph{greedy extension methods}, or \emph{greedy methods} for short, to be a powerful way to refute implications, especially when the carrier $M$ is allowed to be infinite.  Such constructions have a long history in model theory, with possibly the earliest\footnote{We thank Stanley Burris for this reference.} such construction due to Skolem \cite{skolem}. A basic implementation of this method is as follows.  To build a magma operation $\op \colon M \times M \to M$ that satisfies one law $\E$ but not another ${\E'}$, one can first consider \emph{partial magma operations} $\op \colon \Omega \to M$, defined on some subset $\Omega$ of $M \times M$. Thus $x \op y$ is defined if and only if $(x,y) \in \Omega$. A magma operation is then simply a partial operation which is \emph{total} in the sense that $\Omega = M \times M$.  We say that a partial magma operation is \emph{finitely supported} if $\Omega$ is finite.

In the language of first-order logic (in which functions and relations must be total), it is convenient to view a partial magma operation as a ternary relation $R(x,y,z)$ on $M$ with the axiom that $R(x,y,z) \wedge R(x,y,z') \implies z=z'$ for all $x,y,z \in M$.  The support $\Omega$ is then the set of $(x,y)$ for which $R(x,y,z)$ holds for some (necessarily unique) $z$, which one can then take to be the definition of $z = x \op y$.

We say that one partial operation $\op' \colon \Omega' \to M$ \emph{extends} another $\op \colon \Omega \to M$ if $\Omega'$ contains $\Omega$, and $x \op y = x \op' y$ whenever $x \op y$ (and hence $x \op' y$) are defined. Given a sequence $\op_n \colon \Omega_n \to M$ of partial operations, each of which is an extension of the previous, we can define the \emph{direct limit} $\op_\infty \colon \bigcup_n \Omega_n \to M$ to be the partial operation defined by $x \op_\infty y \coloneqq x \op_n y$ whenever $(x,y) \in \Omega_n$.

Abstractly, the greedy algorithm strategy can now be described as follows.

\begin{theorem}[Abstract greedy algorithm]\label{greedy-abstract} Let $\E,{\E'}$ be equational laws, and let $\Gamma$ be a theory of first-order sentences regarding a  partial magma operations $\op \colon \Omega \to M$ on a carrier $M$.  Assume the following axioms:
\begin{itemize}
  \item[(i)] (Seed) There exists a finitely supported partial magma operation $\op_0 \colon \Omega_0 \to M$ satisfying $\Gamma$ that contradicts ${\E'}$, in the sense that there is some assignment of variables in ${\E'}$ in $M$ such that both sides of ${\E'}$ are defined using $\op_0$, but not equal to each other.
  \item[(ii)]  (Soundness)  If $\op_n \colon \Omega_n \to M$ is a sequence of partial magma operations satisfying $\Gamma$ with each $\op_{n+1}$ an extension of $\op_n$, and the direct limit $\op_\infty$ is total, then this limit satisfies $\E$.
  \item[(iii)] (Greedy extension)  If $\op \colon \Omega \to M$ is a finitely supported partial magma operation satisfying $\Gamma$, and $a,b \in M$, then there exists a finitely supported extension $\op' \colon \Omega' \to M'$ of $\op$ to a possibly larger carrier $M'$, and also satisfying $\Gamma$, such that $a \op' b$ is defined.
\end{itemize}
Then $\E \nmodels {\E'}$.
\end{theorem}

We remark that this greedy method seems to be inherently infinitary in nature, and does not seem well adapted to refute finite magma implications $\E \modelsfin {\E'}$.

\begin{proof}  We work on the countably infinite carrier $\N$.  By embedding the finitely supported operation $\op_0$ from axiom (i) into $\N$, we can assume without loss of generality that $\op_0$ has carrier $\N$.  By similar relabeling, we can assume in (iii) that $M' = M$ when $M=\N$, since any elements of $M' \backslash \N$ that
appear in $\Omega'$ can simply be reassigned to natural numbers that did not previously appear in $\Omega$.  We well-order the pairs in $\N \times \N$ by $(a_n,b_n)$ for $n=1,2,\dots$.  Iterating (iii) starting from $\op_0$, we can thus create a sequence of finitely supported magma operations $\op_0, \op_1, \dots$ on $\N$ satisfying $\Gamma$, with each $\op_{n+1}$ an extension of $\op_n$, and $a_n \op_n b_n$ defined for all $n \geq 1$.  Then the direct limit $\op_\infty$ of these operations is total, and does not satisfy ${\E'}$ thanks to axiom (i).  On the other hand, by axiom (ii) it satisfies $\E$, and the claim follows.
\end{proof}

We refer to $\Gamma$ as the \emph{rule set} for the greedy extension method. To apply \Cref{greedy-abstract} to obtain a refutation $\E \models {\E'}$, we have found the following trial-and-error method to work well in practice:
\begin{itemize}
\item[1.] Start with a minimal rule set $\Gamma$ that has just enough axioms to imply the soundness property for the given hypothesis $\E$.
\item[2.] Attempt to establish the greedy extension property for this rule set by setting $a \op' b$ equal to a new element $c \not \in M$, and then defining additional values of $\op'$ as necessary to recover the axioms of $\Gamma'$.
\item[3.]  If this can be done in all cases, then locate a seed $\op_0$ refuting the given target ${\E'}$, and \texttt{STOP}.
\item[4.]  If there is an obstruction (often due to a ``collision'' in which a given operation $x \op' y$ is required to equal two different values), add one or more rules to $\Gamma$ to avoid this obstruction, and return to Step 2.
\end{itemize}

As an example, we present

\begin{proposition}[$\Eq{73} \nmodels \Eq{4380}$]\label{73-4380} The law $\x \formaleq \y \op (\y \op (\x \op \y))$ \eqref{eq73} does not imply $\x \op (\x \op \x) \formaleq (\x \op \x) \op \x$ \eqref{eq4380}.
\end{proposition}

\begin{proof} To build a rule set $\Gamma$ that will imply $\Eq{73}$ when total, a natural first choice would be the single rule
\begin{itemize}
\item[1.] If $y \op (x \op y)$ is defined, then $y \op (y \op (x \op y))$ is defined and equal to $x$.
\end{itemize}
However, the greedy algorithm will fail just with this rule: if the partial operation has $x \op y$ and $z \op y$ both equal to some $w$ for some $x \neq z$, then any attempt to assign a value to $y \op (y \op w)$ will lead to a contradiction, as the above rule will force $y \op w$ to equal both $x$ and $z$.  Indeed, it is clear that $\Eq{73}$ forces all the right translation operators $R_y$ to be injective.  We therefore add this as an additional rule:
\begin{itemize}
\item[2.] If $x \op y$ and $z \op y$ are defined and equal, then $x=z$.
\end{itemize}
To avoid some unwanted edge cases, it is also convenient to impose the additional rule
\begin{itemize}
  \item[3.] If $x \op y$ is defined, it is not equal to $y$.
\end{itemize}
Unlike Rule 2, this rule is not forced by $\Eq{73}$, but can be enforced as part of the greedy construction.

The ruleset clearly satisfies the soundness axiom (ii) of \Cref{greedy-abstract}.  We now verify the greedy extension axiom (iii).  Let $\Omega,a,b$ be as in that axiom. We may assume that $a \op b$ is undefined, since we are done otherwise. We adjoin a new element $c$ to $M$ to create $M'$, and set $a \op' b = c$.  If we also have $b = d \op a$ for some $d$ (unique by Rule 2, and only possible for $a \neq b$ by Rule 3), set $a \op' c = d$ (this is necessary to retain Rule 1).  Of course, we also set $x \op' y = x \op y$ whenever $x \op y$ is already defined.

Since $c \not \in M$, it is clear that $\op'$ is a finitely supported partial magma operation on $M'$.  It is also clear that $\op'$ satisfies Rule 2 and Rule 3.   Now we case check Rule 1:
\begin{itemize}
\item Case 1: $x=c$ or $y=c$.  Not possible since no left multiplication with $c$ is defined.
\item Case 2: $x \op' y = c$.  Only possible when $x = a$, $y = b$, but then $y \op' (x \op' y)$ is undefined since $y = b \neq a$ if $d$ is defined.
\item Case 3. $y \op' (x \op' y) = c$.  Only possible when $y=a$ and $x=d$, and holds in this case.
\item Case 4: $x, y, x \op' y, y \op' (x \op' y) \neq c$: In this case $\op'=\op$ on all pairs, so the claim reduces to Rule 1 for $\op$, which holds by the induction hypothesis.
\end{itemize}
To conclude, we need to locate a seed $\op_0$ satisfying Rules 1,2,3 and containing a counterexample to $\Eq{4380}$.  One simple example is the carrier $\{0,1,2,3\}$ with $0 \op_0 0 = 1$, $0 \op_0 1 = 2$, $0 \op_0 2 = 0$, $1 \op_0 0 = 3$.
\end{proof}

This method is not guaranteed to halt in finite time, as there may be increasingly lengthy sets of rules one has to add to $\Gamma$ to avoid collisions.  However, in practice we have found many of the refutations that could not be resolved by simpler techniques to be amenable to this method (or variants thereof, as discussed below).

One can automate the above procedure by using ATPs (or SAT solvers) to locate new rules that are necessary and sufficient to resolve any potential collision (and which, \emph{a posteriori}, can be seen to be necessarily consequences of the law $\E$).  The seed-finding step (Step 3) is particularly easy to automate, and can also often be done by hand.  In some cases, the SAT solver calculations provided by these methods were difficult to formalize efficiently in Lean, and so we elected in some cases to replace computer-generated rulesets with shorter human-generated versions in preparation for the formalization step.

However, in some cases we have found it necessary to add ``inspired'' choices of rules that were not forced by the initial hypothesis $\E$, but which simplified the analysis by removing problematic classes of collisions from consideration.  We were unable to fully automate the process of guessing such choices; however, we found ATPs very useful for testing any proposed such guess.  In particular, if an ATP was able to show that the existing ruleset, together with a proposed new rule $A$, implied ${\E'}$, then this clearly indicated that one should not add $A$ to the rule set $\Gamma$.  Conversely, if an ATP failed to establish such an implication, this was evidence that this was a ``safe'' rule to impose.

We also found that human verification of the greedy extension property was a highly error-prone process, as the case analysis often included many delicate edge cases that were easy to overlook.  Both ATPs and the Lean formalization therefore played a crucial role in verifying the human-written greedy arguments, often revealing important gaps in those arguments that required either minor or major revisions to the rule set.

The greedy method can also be combined with the translation-invariant method, both in abelian and non-abelian settings. For instance, we can modify the proof of \Cref{greedy-abstract} to obtain the following variant:

\begin{theorem}[Noncommutative translation-invariant greedy algorithm]\label{nc-greedy-abstract} Let $F,F'$ be functional equations on groups, and let $\Gamma$ be a theory of first-order sentences regarding a partial function $f \colon \Omega \to G$ on a group $(G,\cdot, \cdot^{-1},1)$.  Assume the following axioms:
  \begin{itemize}
    \item[(i)] (Seed) There exists a finitely supported partial function $f_0 \colon \Omega_0 \to G$ satisfying $\Gamma$ that contradicts $F'$, in the sense that there is some assignment of variables in $F'$ in $G$ such that both sides of $F'$ are defined using $f_0$, but not equal to each other.
    \item[(ii)]  (Soundness)  If $f_n \colon \Omega_n \to G$ is a sequence of partial functions satisfying $\Gamma$ with each $f_{n+1}$ an extension of $f_n$, and the direct limit $f_\infty$ is total, then this limit satisfies $F$.
    \item[(iii)] (Greedy extension)  If $f \colon \Omega \to G$ is a finitely supported partial function satisfying $\Gamma$, and $a \in G$, then there exists a finitely supported extension $f' \colon \Omega' \to G'$ of $f$ to a possibly larger group $G'$, and also satisfying $\Gamma$, such that $f'(a)$ is defined.
  \end{itemize}
  Then $F \nmodels F'$.
\end{theorem}

One can of course also develop an abelian analogue of the above theorem, in which $(G,+,-,0)$ and $(G',+,-,0)$ are now required to be abelian.  We can then give an alternate proof of \Cref{73-4380} as follows:

\begin{proof}[Second proof of \Cref{73-4380}] (Sketch)  The functional equations associated to $\Eq{73}$ and $\Eq{4380}$ are
$f^2(h^{-1} f(h)) =h^{-1}$ and $f^2(1) = f(1) f(f(1)^{-1})$ respectively.  We apply \Cref{nc-greedy-abstract} with the following ruleset:
\begin{itemize}
  \item[1.]  If $f(h^{-1} f(h))$ is defined, then $f^2(h^{-1} f(h))$ is defined and equal to $h^{-1}$.
  \item[2.]  If $h^{-1} f(h)$ and $k^{-1} f(k)$ are defined and equal, then $h=k$.
  \item[3.]  If $f(h)$ is defined, it is not equal to $h$.
\end{itemize}
Axiom (ii) is clear.  To verify axiom (iii), we can assume $f(h)$ is undefined, then adjoin an element $c$ freely to $G$ to create a larger group $G'$, and set $f'(h) = c$.  If $h = k^{-1} f(k)$ for some $k$ (which is unique by Rule 2, and only possible for $h \neq 1$ by Rule 3), then also set $f'(c) = k^{-1}$.  One can then check that axiom (iii) is satisfied.  For axiom (i), take $G$ to be a free cyclic group with one generator $a$, and set $f(1) = a$, $f(a) = a^3$, $f(a^3) = 1$, $f(a^{-1}) = a^3$ (say).
\end{proof}

More complex (and \emph{ad hoc}) variants of the greedy algorithm are possible.  In some cases, we were not able to preserve the finitely supported nature of the partial operation or partial function, and needed to extend that partial object at an infinite number of values at each step.  In other cases, one also had to add additional temporary data during the greedy process to record tasks that one wished to attend to at a later stage of the process, but could not handle immediately because it was awaiting some other operation to become well-defined.  We will not attempt to survey all possible variants of this method here, but refer the reader to the ETP blueprint for further examples.

\subsection{Modifying base models}\label{modify-base}

A general technique that we have found useful in obtaining a refutation such as $\E \nmodels {\E'}$ is to start with a simple base model $\Magma = (M,\op)$ that satisfies both $\E$ and ${\E'}$, and modify it in various ways to preserve $\E$, but create a violation of ${\E'}$.  There are many such possible modifications, but three general ways that have proven effective are as follows:

\begin{itemize}
  \item[(i)]  Modify the magma operation $\op \colon M \times M \to M$ on a small set in order to violate ${\E'}$, and then make further modifications as needed to recover $\E$.
  \item[(ii)]  Construct an \emph{extension} $\MagmaN$ of $\Magma$, equipped with a surjective magma homomorphism $\pi: \MagmaN \to \Magma$, and defined in terms of some additional data.  Then solve for that data in such a way that $\MagmaN$ satisfies $\E$ but not ${\E'}$.
  \item[(iii)]  Construct an \emph{enlargement} $\Magma' = (M',\op')$ of $\Magma = (M,\op)$, which is a magma that contains $\Magma$ as a submagma.  One needs to construct the multiplication table $\op$ on $(M' \times M') \backslash (M \times M)$ in order to retain $\E$ but disprove ${\E'}$.
\end{itemize}

One appealing case of (ii) that our project discovered, involving a ``magma cohomology'' analogous to (abelian) group cohomology, is that of an \emph{affine} extension of a magma ${\mathcal G} = (G,\op_G)$ by another magma $(M,\op_M)$ which is an abelian group $M$ with a linear magma operation $s \op_M t \coloneqq as + bt$ for some endomorphisms $a,b \in \mathrm{End}(M)$.  One can then consider extensions with carrier $G \times M$ and magma operation
\begin{equation}\label{xsyt}
 (x, s) \op (y, t) \coloneqq (x \op_G y, s \op_M t + f(x,y))
\end{equation}
for some function $f \colon G \times G \to M$.  If $(M,\op_M)$ and $(G,\op_G)$ already satisfy a law $\E$, then this extension will also satisfy $\E$ if and only if $f$ satisfies a certain ``cocycle equation'', which is a linear equation on $f$.  One can then sometimes use linear algebra to locate an $f$ that satisfies the cocycle equation for one law $\E$ but not another ${\E'}$, thus refuting the implication $\E \models {\E'}$.  An example is as follows:

\begin{proposition}[$\Eq{1110} \nmodels \Eq{1629}$]\label{1110-1629} The law $\x \formaleq \y \op ((\y \op (\x \op \x)) \op \y)$ \eqref{eq1110} does not imply $\x \formaleq (\x \op \x) \op ((\x \op \x) \op \x)$ \eqref{eq1629}, even for finite magmas.
\end{proposition}

\begin{proof}  (Sketch) Using the linear ansatz, we find that $\Eq{1110}$ has a model $\Magma$ with carrier $\F_5$ (the finite field $\Z/5\Z$) with operation $x \op y = 3x-y$.  We then apply the ansatz \eqref{xsyt} with $G=M$.  One then finds that this operation satisfies $\Eq{1110}$ if $f \colon \F_5 \times \F_5 \to \F_5$  the cocycle equation
  $$3f(x,x) - 3f(y,2x) - f(3y-2x,y) + f(y,3y-x) = 0$$
for all $x,y \in \F_5$, and satisfies $\Eq{1629}$ if $f$ satisfies the cocycle equation
$$ f(2x,0) - f(2x,2x) = 0$$
for all $x \in \F_5$.  A routine symbolic algebra package computation reveals that the space of $f$ that satisfies the former equation is a six-dimensional vector space over $\F_5$, which is not contained in the solution space of the latter equation, giving the claim.
In fact, since these equations preserve the space of homogeneous polynomials of a fixed degree, one can use linear algebra to locate an example that is a homogeneous polynomial; one explicit choice is
\[
f(x,y) = y^5 +xy^4 + x^2y^3 +3x^3 y^2 + 3x^4 y. \qedhere
\]
\end{proof}

It may be of interest to develop this theory of ``magma cohomology'' further, for instance by defining higher order magma cohomology groups.

Now we give an example of how method (ii) can be combined with method (i).

\begin{proposition}[$\Eq{1659} \nmodels \Eq{4315}$]\label{1659-4315} The law $\x \formaleq (\x \op \y) \op ((\y \op \y) \op \z)$ \eqref{eq1659} does not imply $\x \op (\y \op \x) \formaleq \x \op (\y \op \z)$ \eqref{eq4315}.
\end{proposition}

\begin{proof}  There are two simple models for $\Eq{1659}$: the model $G$ with carrier $\Z/2\Z$ and operation $x \op y = x+1$, and the model $\Magma$ with carrier $\Z$ and operation $x \op y = x$.  Using the ansatz \eqref{xsyt}, one can soon discover that one obtains a magma operation $\op: (G \times \Z) \times (G \times \Z) \to G \times \Z$ with $f(0,0)=f(1,0)=0$, $f(0,1)=-1$, and $f(1,1)=1$.  This model still satisfies $\Eq{4315}$. However, we can create a modification $\op'$ of $\op$ as follows.  We will seek to violate $\Eq{4315}$ at $x = (0,0)$, $y = (0,0)$, $z = (1,0)$, thus we want
$$ (0,0) \op' ((0,0) \op' (0,0)) \neq (0,0) \op' ((0,0) \op' (1,0)).$$
We have $(0,0) \op (0,0) = (1,0)$ and $(0,0) \op (1,0) = (1,-1)$.  One can try to force the counterexample by setting $(0,0) \op' (1,0)$ to equal $(0,0)$ instead of $(1,-1)$. However, if this is the only change we make, then we no longer satisfy $\Eq{1659}$, since
$$ (1,0) \neq ((0,0) \op' (1,0)) \op' (((1,0) \op' (1,0)) \op' (1,t))$$
for any $t \in \N \backslash \{0\}$. But these are the only counterexamples created involving elements in the subset $G \times \N$ of $G \times \Z$; and if one then sets $(0,0) \op' (1,t) = (0,0)$ for \emph{all} $t \in \N$, and then restricts to $G \times \N$ (which is now closed under $\op'$), then one can check that the modified operation $\op'$ on this submagma now satisfies $\Eq{1659}$ but not $\Eq{4315}$ as required.
Incidentally, this submagma is isomorphic to the magma $\Magma'=(\Z,\op'')$ with $m\op''n=-m$ for $n<0$ and $m\op''n=-m-1$ for $n\geq 0$ under the bijection that maps $(0,s)$ to $s$ and $(1,s)$ to $-s-1$.
\end{proof}

The specific law $\x \formaleq \x \op ((\y \op \z) \op (\x \op \z))$ \eqref{eq854} turned out to be somewhat ``mutable'', in the sense that one can often change a small number
 of entries in the multiplication table of a finite magma satisfying this law, or add rows and columns to the table,
 in ways that preserve the law $\Eq{854}$.  This makes the law amenable to methods (i) and (iii) to construct new models of this equation that
 refute various implications  $\Eq{854} \nmodelsfin \E$, for instance by starting with a model that already refuted some stronger law ${\E'}$, and then attempting to modify it
 (possibly with ATP assistance) by some combination of methods (i) and (iii) to produce a model that violates $\E$.

 Some heuristics loosely inspired by discrete-time dynamical systems proved helpful.
 The idea is to generate a sequence of magmas, each of which is generated from the previous entry by applying various operations expected to increase the likelihood of
 finding a refutation.  This is similar to the greedy methods in \ref{greedy-sec}, except that we require our resulting magma to be finite and completely
 defined, and our transformations need not be deterministic.

 Since our goal is simply to find a finite model — and any candidate can be checked directly — we are not limited to transformations that can be rigorously justified.
  SAT solvers like
 \emph{Glucose}~\cite{DBLP:conf/ijcai/AudemardS09,DBLP:conf/cp/AudemardS12} inspired by the earlier \emph{MiniSAT}~\cite{DBLP:conf/sat/EenS03},
 via convenient interfaces like \emph{PySAT}~\cite{imms-sat18, itk-sat24},
 other fast SAT solvers such as \emph{Kissat}~\cite{BiereFazekasFleuryHeisinger-SAT-Competition-2020-solvers},
 counterexample finders like \emph{Mace4}~\cite{prover9-mace4}, and more general ATPs like
 \emph{Vampire}~\cite{DBLP:conf/cav/KovacsV13} which can be used as solvers, all succeeded in finding useful magmas following this approach.

 For example, suppose our goal is to show $\Eq{854} \nmodelsfin \E$, for some $\E$.  We start with a magma table which
 satisfies both equations, and remove a random subset of the table entries (creating a partially defined magma).  We then
 ask the ATP to find a magma which satisfies $\Eq{854}$, filling in the unspecified values and potentially adding new elements.
 If in fact $\E$ is not implied by $\Eq{854}$, the ATP might succeed in finding a magma refuting the implication.
 We may also directly insert a violation of $\E$ into the magma cells we have emptied, hoping that a consistent completion still exists.
 Another method, by analogy with slowly introducing forcing terms into numerical integrations while preserving adiabatic invariants,
 is to impose selected implications of a given equation without directly enforcing the equation itself.
 This can gradually drive the magmas in the sequence toward satisfying the equation without immediately imposing it.

Combining several of these techniques allowed us to find proofs of
$$\Eq{854} \nmodelsfin \Eq{413}, \Eq{1045}, \Eq{1055}, \Eq{3316}, \Eq{3925}.$$

As an example of the process, we started with a magma that satisfied $\Eq{854}$ and all the above equations,
but had an $\Eq{10}$ violation.  We suspected that $\Eq{10}$ might be relevant (and later found an
argument showing multiple $\Eq{10}$ violations would be required in a magma which showed $$\Eq{854} \nmodelsfin \Eq{1055}$$),
and so used \emph{Kissat} and \emph{Vampire} to grow $\Eq{854}$ magmas with such violations.  These larger magmas were then used as
seeds for the random evolution process, and the ATPs eventually succeeded in finding magmas which satisfied $\Eq{854}$ but refuted
the implications in question.

Note that these approaches have their limitations.  To be effective, it must be easy to transition between different
states, which usually involves finding a magma satisfying the equation of interest or at least some related one.
Equations whose finite magmas are difficult to find (e.g.\ $\Eq{677}$), whether because of absolute rarity or the numerical challenges
that our ATPs have in finding them without taking advantage of a structural ansatz, appear resistant to these methods in practice.

Another way to utilize (iii), which proved useful for laws that involved the squaring operator $S$, was to adopt a ``squares first'' approach in which one selected a base model $S\Magma = (SM,\op)$ to serve as the set of squares, then extend it to a larger model $\Magma$ with carrier $M = SM \uplus N$ by first determining what the multiplication map should be on the diagonal $\{ (x,x): x\in N\}$ (i.e., to determine the squaring map $S \colon N \to SM$), together with the values on the blocks $SM \times N$, $N \times SM$, and then finally resolve the remaining values on the $N \times N$ block.  Often, versions of the greedy algorithm are useful for each of these stages of the construction.  The precise details are quite technical, particularly for the law $\x \formaleq (\y \op \y) \op ((\y \op \x) \op \y)$ \eqref{eq1729}, which was the last of the equations whose implications were settled by the ETP.  We refer the reader to the ETP blueprint for further details.
