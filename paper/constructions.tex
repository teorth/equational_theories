
\section{Counterexample constructions}

In this section we collect the various techniques developed in the ETP to construct counterexamples to various implications $E \vdash E'$.

\subsection{Finite magmas}\label{finite-sec}

A finite magma $M$ of order $n$ can be labeled by $\{1,\dots,n\}$ and described by specifying the multiplication table $\op \colon \{1,\dots,n\} \times \{1,\dots,n\} \to \{1,\dots,n\}$.  By generating a list of all the equational laws $En$, $n=1,\dots,4694$ obeyed by this magma, one can create refutations: if $M \models En$ and $M \not \models Em$, then clearly $E_n \not \vdash E_m$.  It is feasible to brute force over all $\sum_{n=2}^4 n^{n^2} \approx 4.3 \times 10^9$ non-trivial magmas of order at most $4$ to obtain many refutations of this type.  \note{Report on how many implications that can be obtained in this way.}

However, it is not feasible to exhaustively search over the $5^{5^2} \approx 3 \times 10^{17}$ magmas of order $5$, even after quotienting out by isomorphism and symmetry (which roughly saves a factor of $5! \times 2 = 240$).  Randomly sampling such magmas did not produce significant refutations, as random magmas of order $5$ tended to obey few laws, and the set of laws covered were usually also exhibited by smaller magmas.  A more fruitful approach was to randomly sample from magmas with additional properties that encouraged satisfiability of a greater set of laws.  These included linear and quadratic magmas (discussed below), and cancellative magmas.  On the other hand, some classes of magmas, such as commutative magmas, ended up producing a disappointingly small number of additional refutations.

For specific refutations, it was sometimes possible to locate a finite example with an ATP, particularly if one also imposed additional axioms (e.g., an idempotence axiom $x = x \op x$) that one suspected would be useful.  For medium-sized magmas (of order $n=5,6,7,8$), this appeared to be a more efficient approach than brute force exhaustion of all such magmas.

\note{Discuss this further, perhaps give an example, or refer to the ATP section.  See also the discussion threads ``Counterexamples by enumerating words in quotient magmas'' and ``Using SAT solvers for model generation'' threads (sorry, LaTeX is choking on the URLs for some reason).}

It is a result of Kisielewicz \cite{Kisielewicz} that every law $En$ with $n \leq 4694$ is either equivalent to the singleton law $E2$, or else has a non-trivial finite model.  In fact our brute force search revealed that in the latter case there is always a model of order $2 \leq n \leq 5$, with the lone exception of \eqref{eq1286} (and its dual \eqref{eq2301}), for which the smallest non-trivial finite model was of order $7$, as presented in \Cref{1286-ex} below.  In fact, most of the 4694 laws either only had trivial models, or had a order 2 model, as shown in \Cref{size-table}.
\begin{table}
\centering
\begin{tabular}{ll}
  \hline
Order of smallest non-trivial model & Number of laws \\
\hline
Trivial only & $1496$ \\
$2$ & $3136$ \\
$3$ & $32$ \\
$4$ & $14$ \\
$5$ & $14$ \\
$7$ & $2$\\
\hline
\end{tabular}
\caption{Number of laws of order at most $4$ whose smallest non-trivial model is of a given size.}\label{size-table}
\end{table}
\subsection{Linear models}\label{linear-sec}

A fruitful source of counterexamples is the class of \emph{linear magmas}, where the carrier $M$ is a ring (which may be commutative or non-commutative, finite or infinite), and the operation $\op$ is given by $x \op y = ax + by$ for some coefficients $a,b \in M$; one can also generalize this slightly to \emph{affine magmas}, in which the operation is given by $x \op y = ax + by + c$, but for simplicity we shall focus on linear magmas here.  It is easy to see that in a linear magma, any word $w(x_1,\dots,x_n)$ of $n$ indeterminates also takes the linear form
$$ w(x_1,\dots,x_n) = \sum_{i=1}^n P_{w,i}(a,b) x_i$$
for some (possibly non-commutative) polynomial $P_{w,i}$ in $a,b$ with integer coefficients.  Thus, a linear magma will obey an equational law $w_1 \formaleq w_2$ if and only if the pair $(a,b)$ lies in the (possibly non-commutative) variety
\begin{equation}\label{variety}
  \{ (a,b) \in M \times M: P_{w_1,i}(a,b) = P_{w_2,i}(a,b) \hbox{ for all } i \}.
\end{equation}
As such, a necessary condition for such a law $w_1 \formaleq w_2$ to entail another law $w'_1 \formaleq w'_2$ is that one has the inclusion
$$ \{ (a,b) \in M \times M: P_{w_1,i}(a,b) = P_{w_2,i}(a,b) \hbox{ for all } i \} \subset
\{ (a,b) \in M \times M: P_{w'_1,i}(a,b) = P_{w'_2,i}(a,b) \hbox{ for all } i \} $$
for all rings $M$.  For commutative rings, this criterion can be checked by standard Grobner basis techniques; in the noncommutative case one can use methods such as the diamond lemma \cite{diamond-lemma}.

\begin{example}[Commutative counterexample]\label{1286-ex} For the law $x = y \op (((x \op y) \op x) \op y)$ \eqref{eq1286}, the variety \Cref{variety} can be computed to be
$$ \{ (a,b) \in M \times M: 1 = a+ba^3+bab, 0 = a + ba^2 b + b^2 \}$$
while the variety for the idempotent law \eqref{eq3} is
$$ \{ (a,b) \in M: a+b=1 \}.$$
Thus to show that \eqref{eq1286} does not entail \eqref{eq3}, it suffices to locate elements $a,b$ of a ring $M$ for one has $1 = a+ba^3+bab$, $0 = a + ba^2 b + b^2$, and $a+b \neq 1$.  Here one can take a commutative example, for instance when $M = \Z/p\Z$ and $(p,a,b) = (11,1,7)$ or $(p,a,b)=(7,6,2)$.
\end{example}

\begin{example}[Noncommutative counterexample]\label{1117-ex} For the law $x = y \op ((y \op (x \op z)) \op z)$ \eqref{eq1117}, the variety \Cref{variety} can be computed to be
$$ \{ (a,b) \in M \times M: 1 = baba, 0 = a+ba^2, 0 = bab^2 + b^2 \}$$
while the variety for $x = (x \op ((x \op x) \op x)) \op x$ \eqref{eq2441} is
$$ \{ (a,b) \in M \times M: a^2 + aba^2 + abab + ab^2 + b = 1 \}.$$
Observe that if $ba = -1$, then $(a,b)$ automatically lies in the first set, and lies in the second set if and only if $(ab+1)(b-1) = 0$.  One can then show that \eqref{eq1117} does not imply \eqref{eq2441} by setting $a = L$, $b = -R$ where $L, R$ are the left and right shift operators respectively on the ring of integer-valued sequences $\Z^\N$.  With some \emph{ad hoc} effort one can convert this example into a less linear, but simpler (and easier to formalize) example, namely the magma with carrier $\Z$ and operation $x \op y = 2x - \lfloor y/2 \rfloor$.
\end{example}

\begin{remark} As essentially observed in \cite{austin}, if there is a commutative linear counterexample to an implication $E \vdash E'$, then by the Lefschetz principle this counterexample can be realized in a finite field ${\mathbb F}_q$ for some prime power $q$ (and by the Chebotarev density theorem one can in fact take $q$ to be a prime, so that the carrier is of the form $\Z/p\Z$ for some prime $p$).  As such, we have found that an effective way to refute implications by the commutative linear magma method is to simply perform a brute force search over linear magmas $x \op y = ax + by$ in $\Z/p\Z$ for various triples $(p,a,b)$. \note{Discuss performance of this method.}

On the other hand, the refutations obtained by non-commutative linear constructions need not have a finite model.  For instance, consider the refutation $E1117 \not \vdash E2441$ from \Cref{1117-ex}.  The law \eqref{eq1117} can be rewritten as $L_y R_z L_y R_z x = x$.  This implies that $R_z$ is injective and $L_y$ is surjective for all $y,z$.  For finite magmas $M$, this then implies that the $L_y, R_z$ are in fact invertible, and hence we have also $R_z L_y R_z L_y x = x$, which implies \eqref{eq2441} by setting $x=y=z$.  Thus the refutation $E1117 \not \vdash E2441$ is ``immune'' to finite counterexamples.
\end{remark}

\begin{remark}  One can also consider nonlinear magma models, such as quadratic models $x \op y = ax^2 + bxy + cy^2 + dx + ey + f$ in a cyclic group $\Z/N\Z$.  For small values of $N$, we have found such models somewhat useful in providing additional refutations of implications $E \vdash E'$ beyond what can be achieved by the linear or affine models.  However, as the polynomials associated to a word $w(x_1,\dots,x_n)$ tend to be of high degree (exponential in the order of the word), it becomes quite rare for such models to obey a given equation $E$ when $N$ is large.
\end{remark}

\begin{remark} One can also consider the seemingly more general linear model $x \op y = ax + by$, where the carrier $M$ is now an abelian group, and $a,b$ act on $M$ by homomorphisms, that is to say that they are elements of the endomorphism ring $\mathrm{End}(M)$.  However, this leads to exactly the same varieties \Cref{variety} (where $M$ is now replaced by the endomorphism ring $\mathrm{End}(M)$) and so does not increase the power of the linear model for the purposes of refuting implications.
\end{remark}

\note{Give some statistics of what proportion of refutations can be resolved by linear models.}

On the other hand, there are certainly some refutations $E \not \vdash E'$ of implications that are ``immune'' to both commutative and non-commutative models, in the sense that all such models that obey $E$, also obey $E'$.  One such example is the refutation $E1485 \vdash E151$, which we discuss further in \Cref{twisting-sec} below.

\subsection{Translation-invariant models}\label{translation-sec}

It is natural to look for counterexamples amongst magmas that obey a large number of symmetries.  One such class of counterexamples are \emph{translation-invariant models}, in which the carrier $M$ is a group, and the left translations of this group form isomorphisms of the magma $M$.  In the case of an abelian group $M = (M,+)$, such models take the form
\begin{equation}\label{xop-add}
  x \op y = x + f(y-x)
\end{equation}
for some function $f \colon M \to M$; in the case of a non-abelian group $M = (M,\cdot)$, such models instead take the form
\begin{equation}\label{xop-mul}
x \op y = x f(x^{-1} y).
\end{equation}
For such models, the verification of an equational law in $n$ variables corresponds to a functional equation for $f$ in $n-1$ variables, as the translation symmetry allows one to normalize one variable to be the identity (say). This can simplify an implication to the point where an explicit counterexample can be found.  These functional equations are trivial to analyze when $n=1$.  For $n=2$, they are not as trivial, but still quite tractable, and has led to several refutations in practice.  The method does not appear to be particularly effective for $n>2$ due to the complexity of the functional equations.

\begin{example}[Abelian example]\label{abex}  For the law $\x \formaleq (\x \op \y) \op ((\x \op \y) \op \y)$ \eqref{eq1648}, we apply the abelian translation-invariant model \Cref{xop-add} with $y=x+h$ to obtain
\begin{align*}
  x \op y &= x + f(h) \\
  (x \op y) \op y &= x + f(h) + f(h-f(h)) \\
  (x \op y) \op ((x \op y) \op y) &= x + f(h) + f(f(h-f(h)))
\end{align*}
so that this law obeys \eqref{eq1648} if and only if the functional equation
$$f(h) + f(f(h-f(h))) = 0$$
holds for all $h \in M$.  Similarly, the law $\x \formaleq (\x \op (\x \op \y)) \op \y$ \eqref{eq206} is obeyed if and only if
$$ f(f(h)) + f(h - f(f(h))) = 0$$
for all $h \in M$.  One can now check that the function $f \colon \Z \to \Z$ defined by $f(h) \coloneqq - \mathrm{sgn}(h)$ (thus $f(h)$ equals $-1$ when $h$ is positive, $+1$ when $h$ is negative, and $0$ when $h$ is zero) obeys the first functional equation but not the second, thus establishing that $E1648 \not \vdash E206$.
\end{example}

\begin{example}[Non-abelian example]\label{trans-nonab}  We now obtain the opposite refutation $E206 \not \vdash E1648$ to \Cref{abex} using the non-abelian translation-invariant model.  By similar calculations to before, we now seek to find a function $f \colon M \to M$ on a non-abelian group $(M,\cdot)$ that obeys the functional equation
\begin{equation}\label{206-eq}
 f(f(h)) f(f(f(h))^{-1} h) = 1
\end{equation}
for all $h \in M$, but fails to obey the functional equation
\begin{equation}\label{1648-eq}
   f(h) f(f(f(h)^{-1} h)) = 1
\end{equation}
for at least one $h \in M$.  Now take $M$ to be the group generated by three generators $a,b,c$ subject to the relations $a^2=b^2=c^2=1$, or equivalently the group of reduced words in $a,b,c$ with no adjacent letters in the word equal.  We define
$$ f(1) = 1, f(a)=b, f(b) = c, f(c) = a$$
and then $f(aw)=a$ for any non-empty reduced word $w$ not starting with $a$, and similarly for $b$ and $c$.  The equation \Cref{206-eq} can be checked directly for $h=1,a,b,c$.  If $h=aw$ with $w$ non-empty, reduced, and not starting with $a$, then $f(f(h))^{-1} = f(f(h)) = b$ and $f(f(f(h))^{-1} h) = f(baw) = b$, giving \Cref{206-eq} in this case, and similarly for cyclic permutations. Meanwhile, \Cref{1648-eq} can be checked to fail for $h=a$.
\end{example}

\begin{remark}  The construction in \Cref{trans-nonab} also has the following more ``geometric'' interpretation.  The carrier $M$ can be viewed as the infinite $3$-regular tree, in which every vertex imposes a cyclic ordering on its $3$ neighbors (for instance, if we embed $M$ as a planar graph, we can use the clockwise ordering).  For $x,y \in M$, we then define $x \op y$ to equal $x$ if $x=y$.  If $y$ is instead a neighbor of $x$, we define $x \op y$ to be the next neighbor of $x$ in the cyclic ordering.  Finally, if $y$ is distance two or more from $x$, we define $x \op y$ to be the neighbor of $x$ that is closest to $y$.  One can then check that this model obeys \Cref{206-eq} but not \Cref{1648-eq}.
\end{remark}

  Some refutations $E \not \vdash E'$ are ``immune'' by translation-invariant models, in that any translation-invariant model that obeys $E$, also obeys $E'$.  One obstruction is that for such models, the squaring map $S$ is necessarily an invertible map, since $Sx = x + f(0)$ in the abelian case and $Sx = xf(1)$ in the non-abelian case. On the other hand, adding the assumption of invertibility of squares can sometimes make the implication $E \vdash E'$.  For instance, the commutative law $\x \op (\y \op \y) \formaleq (\y \op \y) \op \x$ \eqref{eq4482} for a square and an arbitrary element will imply the full commutative law \eqref{eq43} for translation-invariant models due to the surjectivity of $S$, but does not imply it in general (as one can easily see by considering models where $S$ is constant).

\subsection{The twisting semigroup}\label{twisting-sec}

Suppose one has a magma $M$ obeying a law $E$, that also enjoys some endomorphisms $T, U \colon M \to M$.  Then one can ``twist'' the operation $\op$ by $T,U$ to obtain a new magma operation
\begin{equation}\label{twist} x \op' y := Tx \op Uy.
\end{equation}
If one then tests whether this new operation $\op'$ obeys the same law $E$ as the original operation $\op$, one will find that this will be the case provided that $T,U$ obey a certain set of relations.  The semigroup generated by formal generators $\mathrm{T}, \mathrm{U}$ with these relations will be called the \emph{twisting semigroup} $\operatorname{Twist}_E$ of $E$.  This can be best illustrated with some examples.

\begin{example}  We compute the twisting semigroup of $\x \formaleq (\y \op \x) \op (\x \op (\z \op \y))$ \eqref{eq1485}.  We test this law on the operation \Cref{twist}, thus we consider whether
$$x = (y \op' x) \op' (x \op' (z \op' y))$$
holds for all $x,y,z \in M$.  Substituting in \Cref{twist} and using the homomorphism property repeatedly, this reduces to
$$x = (T^2y \op TUx) \op (UTx \op (U^2T z \op U^3y)).$$
If we impose the conditions $TU=UT$, $T^2 = U^3$, then this equation would follow from \eqref{eq1485} (with $x,y,z$ replaced with $TUx$, $T^2 y$, $U^2 Tz$ respectively).  Thus the twisting semigroup $\operatorname{Twist}_{E1485}$ of \eqref{eq1485} is generated by two generators $\mathrm{T}, \mathrm{U}$ subject to the relations $\mathrm{T} \mathrm{U}=\mathrm{U} \mathrm{T} = 1$, $\mathrm{T}^2 = \mathrm{U}^3$.  This is a cyclic group of order $5$, since the relations can be rewritten as $\mathrm{T}^5 = 1$, $\mathrm{U} = \mathrm{T}^{-1}$.

Now consider $\x \formaleq (\x \op \x) \op (\x \op \x)$ \eqref{eq151}.  Applying the same procedure, we arrive at
$$x = (T^2 x \op TUx) \op (UT x \op U^2 x)$$
so the twisting group $\operatorname{Twist}_{E151}$ is generated by two generators $\mathrm{T}, \mathrm{U}$ subject to the relations $\mathrm{T} \mathrm{U}=\mathrm{U} \mathrm{T} = \mathrm{T}^2 = \mathrm{U}^2 = 1$.  This is a cyclic group of order $2$, since the relations can be rewritten as $\mathrm{T}^2 = 1$, $\mathrm{U} = \mathrm{T}$.
\end{example}

Suppose the twisting semigroup $\operatorname{Twist}_E$ is not a quotient of $\operatorname{Twist}_{E'}$, in the sense that the relations that define $\operatorname{Twist}_{E'}$ are not obeyed by the generators of $\operatorname{Twist}_E$.  Then one can often disprove the implication $E \vdash E'$ by attempting the following procedure.
\begin{itemize}
\item First, locate a non-trivial magma $M$ obeying the law $E$.  Then the Cartesian power $M^{\operatorname{Twist}_E}$ of tuples $(x_W)_{W \in \operatorname{Twist}_E}$, with the pointwise magma operation, will also obey $E$.
\item Furthermore, this Cartesian power admits two endomorphisms $T, U$ defined by
$$ T (x_W)_{W \in \operatorname{Twist}_E} = (x_{W \mathrm{T}})_{W \in \operatorname{Twist}_E};
U (x_W)_{W \in \operatorname{Twist}_E} = (x_{W \mathrm{U}})_{W \in \operatorname{Twist}_E},$$
which obey the relations defining $\operatorname{Twist}_E$.
\item We now twist the magma operation $\op$ on $M^{\operatorname{Twist}_E}$ by $T,U$ to obtain a new magma operation $\op'$ defined by \Cref{twist}, that will still obey law $E$.
\item Because $T, U$ will not obey the relations defining $\operatorname{Twist}_{E'}$, it is highly likely that this twisted operation will not obey $E'$, thus refuting the implication $E \vdash E'$.
\end{itemize}

For instance, a non-trivial finite model for \eqref{eq1485} is given by the finite field $\mathbb{F}_2$ of two elements with the NAND operation $x \op y \coloneqq 1-xy$.  If we twist $\mathbb{F}_2^5$ by the left shift $T(x_i)_{i=1}^5 = (x_{i+1})_{i=1}^5$ and right shift $U(x_i)_{i=1}^5 = (x_{i-1})_{i=1}^5$, where we extend the indices periodically modulo $5$, then the resulting operation
$$ (x_i)_{i=1}^5 \op' (y_i)_{i=1}^5 \coloneqq (1 - x_{i+1} y_{i-1})_{i=1}^5$$
on $\mathbb{F}_2^5$ will still obey \eqref{eq1485}, but will not obey \eqref{eq151}, thus showing that $E1485 \not \vdash E151$.  This particular implication does not seem to be easily establishable by any of the other methods discussed in this paper.

\note{Report on how large the twisting semigroups are in practice, and how many implications can be refuted by this method.}


\subsection{Greedy constructions}\label{greedy-sec}

We have found \emph{greedy extension methods}, or \emph{greedy methods} for short, are a powerful way to refute implications, especially when the carrier $M$ is allowed to be infinite.  A basic implementation of this method is as follows.  To build a magma operation $\op \colon M \times M \to M$ that obeys one law $E$ but not another $E'$, one can first consider \emph{partial magma operations} $\op \colon \Omega \to M$, defined on some subset $\Omega$ of $M \times M$. Thus $x \op y$ is defined if and only if $(x,y) \in \Omega$. A magma operation is then simply a partial operation which is \emph{total} in the sense that $\Omega = M \times M$.  We say that a partial magma operation is \emph{finitely supported} if $\Omega$ is finite.

In the language of first-order logic, a partial magma operation can also be viewed as a ternary relation $R(x,y,z)$ on $M$ with the axiom that $R(x,y,z) \and R(x,y,z') \implies z=z'$ for all $x,y,z \in M$.  The support $\Omega$ is then the set of $(x,y)$ for which $R(x,y,z)$ holds for some (necessarily unique) $z$, which one can then take to be the definition of $z = x \op y$.

We say that one partial operation $\op' \colon \Omega' \to M$ \emph{extends} another $\op \colon \Omega \to M$ if $\Omega'$ contains $\Omega$, and $x \op y = x \op' y$ whenever $x \op y$ (and hence $x \op' y$) are defined. Given a sequence $\op_n \colon \Omega_n \to M$ of partial operations, each of which is an extension of the previous, we can define the \emph{direct limit} $\op_\infty \colon \bigcup_n \Omega_n \to M$ to be the partial operation defined by $x \op_\infty y \coloneqq x \op_n y$ whenever $(x,y) \in \Omega_n$.

Abstractly, the greedy algorithm strategy can now be described as follows.

\begin{theorem}[Abstract greedy algorithm]\label{greedy-abstract} Let $E,E'$ be equational laws, and let $\Gamma$ be a theory of first-order sentences regarding a  partial magma operations $\op \colon \Omega \to M$ on a carrier $M$.  Assume the following axioms:
\begin{itemize}
  \item[(i)] (Seed) There exists a finitely supported partial magma operation $\op_0 \colon \Omega_0 \to M$ satisfying $\Gamma$ that contradicts $E'$, in the sense that there is some assignment of variables in $E'$ in $M$ such that both sides of $E'$ are defined using $\op_0$, but not equal to each other.
  \item[(ii)]  (Soundness)  If $\op_n \colon \Omega_n \to M$ is a sequence of partial magma operations obeying $\Gamma$ with each $\op_{n+1}$ an extension of $\op_n$, and the direct limit $\op_\infty$ is total, then this limit obeys $E$.
  \item[(iii)] (Greedy extension)  If $\op \colon \Omega \to M$ is a finitely supported partial magma operation obeying $\Gamma$, and $a,b \in M$, then there exists a finitely supported extension $\op' \colon \Omega' \to M'$ of $\op$ to a possibly larger carrier $M'$ such that $a \op' b$ is defined.
\end{itemize}
Then $E \not \vdash E'$.
\end{theorem}

\begin{proof}  We work on the countably infinite carrier $\N$.  By embedding the finitely supported operation $\op_0$ from axiom (i) into $\N$, we can assume without loss of generality that $\op_0$ has carrier $\N$.  By similar relabeling, we can assume in (iii) that $M' = M$ when $M=\N$, since any elements of $M' \backslash \N$ that
appear in $\Omega'$ can simply be reassigned to natural numbers that did not previously appear in $\Omega$.  We well-order the pairs in $\N \times \N$ by $(a_n,b_n)$ for $n=1,2,\dots$.  Iterating (iii) starting from $\op_0$, we can thus create a sequence of finitely supported magma operations $\op_0, \op_1, \dots$ on $\N$ obeying $\Gamma$, with each $\op_{n+1}$ an extension of $\op_n$, and $a_n \op_n b_n$ defined for all $n \geq 1$.  Then the direct limit $\op_\infty$ of these operations is total, and does not obey $E'$ thanks to axiom (i).  On the other hand, by axiom (ii) it obeys $E$, and the claim follows.
\end{proof}

We refer to $\Gamma$ as the \emph{rule set} for the greedy extension method. To apply \Cref{greedy-abstract} to obtain a refutation $E \vdash E'$, we have found the following trial-and-error method to work well in practice:
\begin{itemize}
\item[1.] Start with a minimal rule set $\Gamma$ that has just enough axioms to imply the soundness property for the given hypothesis $E$.
\item[2.] Attempt to establish the greedy extension property for this rule set by setting $a \op' b$ equal to a new element $c \not \in M$, and then defining additional values of $\op'$ as necessary to recover the axioms of $\Gamma'$.
\item[3.]  If this can be done in all cases, then locate a seed $\op_0$ refuting the given target $E'$, and STOP.
\item[4.]  If there is an obstruction (often due to a ``collision'' in which a given operation $x \op' y$ is required to equal two different values), add one or more rules to $\Gamma$ to avoid this obstruction, and return to Step 2.
\end{itemize}

As an example, we present

\begin{proposition}[73 does not imply 4380]\label{73-4380} The law $\x \formaleq \y \op (\y \op (\x \op \y))$ \eqref{eq73} does not imply $\x \op (\x \op \x) \formaleq (\x \op \x) \op \x$ \eqref{eq4380}.
\end{proposition}

\begin{proof} To build a rule set $\Gamma$ that will imply \eqref{eq73} when total, a natural first choice would be the single rule
\begin{itemize}
\item[1.] If $y \op (x \op y)$ is defined, then $y \op (y \op (x \op y))$ is defined and equal to $x$.
\end{itemize}
However, the greedy algorithm will fail just with this rule: if the partial operation has $x \op y$ and $z \op y$ both equal to some $w$ for some $x \neq z$, then any attempt to assign a value to $y \op w$ will lead to a contradiction, as the above rule will force $y \op w$ to equal both $x$ and $z$.  Indeed, it is clear that \eqref{eq73} forces all the right translation operators $R_y$ to be injective.  We therefore add this as an additional rule:
\begin{itemize}
\item[2.] If $x \op y$ and $z \op y$ are defined and equal, then $x=z$.
\end{itemize}
To avoid some unwanted edge cases, it is also convenient to impose the additional rule
\begin{itemize}
  \item[3.] If $x \op y$ is defined, it is not equal to $y$.
\end{itemize}
Unlike Rule 2, this rule is not forced by \eqref{eq73}, but can be enforced as part of the greedy construction.

The ruleset clearly obeys the soundness axiom (ii) of \Cref{greedy-abstract}.  We now verify the greedy extension axiom (iii).  Let $\Omega,a,b$ be as in that axiom. We may assume that $a \op b$ is undefined, since we are done otherwise. We adjoin a new element $c$ to $M$ to create $M'$, and set $a \op' b = c$.  If we also have $b = d \op a$ for some $d$ (unique by Rule 2, and only possible for $a \neq b$ by Rule 3), set $a \op' c = d$ (this is necessary to retain Rule 1).  Of course, we also set $x \op' y = x \op y$ whenever $x \op y$ is already defined.

Since $c \not \in M$, it is clear that $\op'$ is a finitely supported partial magma operation on $M'$.  It is also clear that $\op'$ obeys Rule 2 and Rule 3.   Now we case check Rule 1:
\begin{itemize}
\item Case 1: $x=c$ or $y=c$.  Not possible since no left multiplication with $c$ is defined.
\item Case 2: $x \op' y = c$.  Only possible when $x = a$, $y = b$, but then $y \op' (x \op' y)$ is undefined since $y = b \neq a$ if $d$ is defined.
\item Case 3. $y \op' (x \op' y) = c$.  Only possible when $y=a$ and $x=d$, and holds in this case.
\item Case 4: $x, y, x \op' y, y \op' (x \op' y) \neq c$: this case is covered by Rule 3 for $\op$.
\end{itemize}
To conclude, we need to locate a seed $\op_0$ obeying Rules 1,2,3 but contains a counterexample to \eqref{eq4380}.  One simple example is the carrier $\{0,1,2,3\}$ with $0 \op_0 0 = 1$, $0 \op_0 1 = 2$, $0 \op_0 2 = 0$, $1 \op_0 0 = 3$.
\end{proof}

This method is not guaranteed to halt in finite time, as there may be increasingly lengthy sets of rules one has to add to $\Gamma$ to avoid collisions.  However, in practice we have found many of the refutations that could not be resolved by simpler techniques to be amenable to this method (or variants thereof, as discussed below).

One can automate the above procedure by using ATPs (or SAT solvers) to locate new rules that are necessary and sufficient resolve any potential collision (and which, \emph{a posteriori}, can be seen to be necessarily consequences of the law $E$).  The seed-finding step (Step 3) is particularly easy to automate, and can also often be done by hand.  \note{Describe performance of this automated method.  Discuss the issue that some implications required a large SAT solver calculation that was difficult to formalize efficiently in Lean, prompting human-generated simplified proofs using smaller rulesets.}

However, in some cases we have found it necessary to add ``inspired'' choices of rules that were not forced by the initial hypothesis $E$, but which simplified the analysis by removing problematic classes of collisions from consideration.  We were unable to fully automate the process of guessing such choices; however, we found ATPs very useful for testing any proposed such guess.  In particular, if an ATP was able to show that the existing ruleset, together with a proposed new rule $A$, implied $E'$, then this clearly indicated that one should not add $A$ to the rule set $\Gamma$.  Conversely, if an ATP failed to establish such an implication, this was evidence that this was a ``safe'' rule to impose.

We also found that human verification of the greedy extension property was a highly error-prone process, as the case analysis often included many delicate edge cases that were easy to overlook.  Both ATPs and the Lean formalization therefore played a crucial role in verifying the human-written greedy arguments, often revealing important gaps in those arguments that required either minor or major revisions to the rule set.

The greedy method can also combined with the translation-invariant method, both in abelian and non-abelian settings. For instance, we can modify the proof of \Cref{greedy-abstract} to obtain the following variant:

\begin{theorem}[Non-commutative translation-invariant greedy algorithm]\label{nc-greedy-abstract} Let $F,F'$ be functional equations on groups, and let $\Gamma$ be a theory of first-order sentences regarding a partial function $f \colon \Omega \to G$ on a group $G = (G,\cdot)$.  Assume the following axioms:
  \begin{itemize}
    \item[(i)] (Seed) There exists a finitely supported partial function $f_0 \colon \Omega_0 \to G$ satisfying $\Gamma$ that contradicts $F'$, in the sense that there is some assignment of variables in $F'$ in $G$ such that both sides of $F'$ are defined using $f_0$, but not equal to each other.
    \item[(ii)]  (Soundness)  If $f_n \colon \Omega_n \to G$ is a sequence of partial functions obeying $\Gamma$ with each $f_{n+1}$ an extension of $f_n$, and the direct limit $f_\infty$ is total, then this limit obeys $E$.
    \item[(iii)] (Greedy extension)  If $f \colon \Omega \to G$ is a finitely supported partial function obeying $\Gamma$, and $a,b \in G$, then there exists a finitely supported extension $f' \colon \Omega' \to G'$ of $f$ to a possibly larger group $G'$ such that $a \op' b$ is defined.
  \end{itemize}
  Then $F \not \vdash F'$.
\end{theorem}

One can of course also develop an abelian analogue of the above theorem, in which $G = (G,+)$ and $G' = (G',+)$ are now required to be abelian.  We can then give an alternate proof of \Cref{73-4380} as follows:

\begin{proof}[Second proof of \Cref{73-4380}] (Sketch)  The functional equations associated to \eqref{eq73} and \eqref{eq4380} are
$f^2(h^{-1} f(h)) =h^{-1}$ and $f^2(1) = f(1) f(f(1)^{-1})$ respectively.  We apply \Cref{nc-greedy-abstract} with the following ruleset:
\begin{itemize}
  \item[1.]  If $f(h^{-1} f(h))$ is defined, then $f^2(h^{-1} f(h))$ is defined and equal to $h^{-1}$.
  \item[2.]  If $h^{-1} f(h)$ and $k^{-1} f(k)$ are defined and equal, then $h=k$.
  \item[3.]  If $f(h)$ is defined, it is not equal to $h$.
\end{itemize}
Axiom (ii) is clear.  To verify axiom (iii), we can assume $f(h)$ is undefined, then adjoin an element $c$ freely to $G$ to create a larger group $G'$, and set $f'(h) = c$.  If $h = k^{-1} f(k)$ for some $k$ (which is unique by Rule 2, and only possible for $h \neq 1$ by Rule 3), then also set $f'(c) = k^{-1}$.  One can then check that axiom (iii) is obeyed.  For axiom (i), take $G$ to be a free cyclic group with one generator $a$, and set $f(1) = a$, $f(a) = a^3$, $f(a^3) = 1$, $f(a^{-1}) = a^3$ (say).
\end{proof}

More complex (and \emph{ad hoc}) variants of the greedy algorithm are possible.  In some cases, we were not able to preserve the finitely supported nature of the partial operation or partial function, and needed to extend that partial object at an infinite number of values at each step.  In other cases, one also had to add additional temporary data during the greedy process to record tasks that one wished to attend to at a later stage of the process, but could not handle immediately because it was awaiting some other operation to become well-defined.  We will not attempt to survey all possible variants of this method here, but refer the reader to the ETP blueprint for further examples.

\subsection{Modifying base models}\label{modify-base}

A general technique that we have found useful in obtaining a refutation such as $E \not \vdash E'$ is to start with a simple base model $M$ that obeys both $E$ and $E'$, and modify it in various ways to preserve $E$, but create a violation of $E'$.  There are many such possible modifications, but three general ways that have proven effective are as follows:

\begin{itemize}
  \item[(i)]  Modify the magma operation $\op \colon M \times M \to M$ on a small set in order to violate $E'$, and then make further modifications as needed to recover $E$.
  \item[(ii)]  Construct an \emph{extension} $N$ of $M$, equipped with a surjective magma homomorphism $\pi: N \to M$, and defined in terms of some additional data.  Then solve for that data in such a way that $N$ obeys $E$ but not $E'$.
  \item[(iii)]  Construct an \emph{enlargement} $M'$ of $M$, which is a magma that contains $M$ as a submagma.  One needs to construct the multiplication table $\op$ on $(M' \times M') \backslash (M \times M)$ in order to retain $E$ but disprove $E'$.
\end{itemize}

One appealing case of (ii), involving a ``magma cohomology'' analogous to (abelian) group cohomology, is that of an \emph{affine} extension of $M$ by another magma $G$ which is an abelian group $G$ with a linear magma operation $s \op t \coloneqq as + bt$ for some endomorphisms $a,b \in \mathrm{End}(G)$.  One can then consider extensions with carrier $M \times G$ and magma operation
\begin{equation}\label{xsyt}
 (x, s) \op (y, t) \coloneqq (x \op y, s \op t + f(x,y))
\end{equation}
for some function $f \colon G \times G \to M$.  If $M$ and $G$ already obey a law $E$, then this extension will also obey $E$ if and only if $f$ obeys a certain ``cocycle equation'', which is a linear equation on $f$.  One can then sometimes use linear algebra to locate an $f$ that obeys the cocycle equation for one law $E$ but not another $E'$, thus refuting the implication $E \vdash E'$.  An example is as follows:

\begin{proposition}[1110 does not imply 1629]\label{1110-1629} The law $\x \formaleq \y \op ((\y \op (\x \op \x)) \op \y)$ \eqref{eq1110} does not imply $\x \formaleq (\x \op \x) \formaleq ((\x \op \x) \op \x)$ \eqref{eq1629}.
\end{proposition}

\begin{proof}  (Sketch) Using the linear ansatz, we find that \eqref{eq1110} has a model $M$ with carrier $\F_5$ (the finite field $\Z/5\Z$) with operation $x \op y = 3x-y$.  We then apply the ansatz \eqref{xsyt} with $G=M$.  One then finds that this operation obeys \eqref{eq1110} if $f \colon \F_5 \times \F_5 \to \F_5$ obeys the cocycle equation
  $$3f(x,x) - 3f(y,2x) - f(3y-2x,y) + f(y,3y-x) = 0$$
for all $x,y \in \F_5$, and obeys \eqref{eq1629} if $f$ obeys the cocycle equation
$$ f(2x,0) - f(2x,2x) = 0$$
for all $x \in \F_5$.  A routine symbolic algebra package computation reveals that the space of $f$ that obeys the former equation is a six-dimensional vector space over $\F_5$, which is not contained in the solution space of the latter equation, giving the claim.
\end{proof}

It may be of interest to develop this theory of ``magma cohomology'' further, for instance by defining higher order magma cohomology groups.

Now we give an example of how method (ii) can be combined with method (i).

\begin{proposition}[1659 does not imply 4315]\label{1659-4315} $\x \formaleq (\x \op \y) \op ((\y \op \y) \op \z)$ \eqref{eq1659} does not imply $\x \op (\y \op \x) \formaleq \x \op (\y \op \z)$ \eqref{eq4315}.
\end{proposition}

\begin{proof}  There are two simple models for \eqref{eq1659}: the model $G = \Z/2\Z$ with $x \op y = x+1$, and the model $M = \Z$ with model $x \op y = x$.  Using the ansatz \eqref{xsyt}, one can soon discover that one obtains a magma operation $\op: (G \times M) \times (G \times M) \to G \times M$ with $f(0,0)=f(1,0)=0$, $f(0,1)=-1$, and $f(1,1)=1$.  This model still obeys \eqref{eq4315}. However we can create a modification $\op'$ of $\op$ as follows.  We will seek to violate \eqref{eq4315} at $x = (0,0)$, $y = (0,0)$, $z = (1,0)$, thus we want
$$ (0,0) \op' ((0,0) \op' (0,0)) \neq (0,0) \op' ((0,0) \op' (1,0)).$$
We have $(0,0) \op (0,0) = (1,0)$ and $(0,0) \op (1,0) = (1,-1)$.  One can try to force the counterexample by setting $(0,0) \op' (1,0)$ to equal $(0,0)$ instead of $(1,-1)$. However, if this is the only change we make, then we no longer obey \eqref{eq1659}, since
$$ (1,0) \neq ((0,0) \op' (1,0)) \op' (((1,0) \op' (1,0)) \op (1,t))$$
for any $t \in \Z \backslash \{0\}$. But these are the only counterexamples created; and if one then sets $(0,0) \op' (1,t) = (0,0)$ for \emph{all} $t \in \Z$, then one can check that the modified operation $\op'$ now obeys \eqref{eq1659} but not \eqref{eq4315} as required.
\end{proof}

Finite models for the law $\x \formaleq \x \op ((\y \op \z) \op (\x \op \z))$ \eqref{eq854} seems to be somewhat ``mutable'' in that one can often change a small number of entries in the multiplication table, and also add an additional row and column to the table, in ways that preserve the law \eqref{eq854}.  This renders this law suitable for using methods (i), (iii) to construct new models of this equation that refute various implications $E854 \vdash E$, for instance by starting with a model that already refuted some stronger law $E'$, and attempt to modify it (possibly with ATP assistance) by some combination of methods (i), (iii) to then violate $E$. \note{Explain this in more detail}

Another way to utilize (iii), which proved useful for laws that involved the squaring operator $S$, was to adopt a ``squares first'' approach in which one selected a base model $SM$ to serve as the set of squares, then extend it to a larger model $M = SM \uplus N$ by first determining what the multiplication map should be on the diagonal $\{ (x,x): x\in N\}$ (i.e., to determine the squaring map $S \colon N \to SM$), together with the values on the blocks $SM \times N$, $N \times SM$, and then finally resolve the remaining values on the $N \times N$ block.  Often, versions of the greedy algorithm are useful for each of these stages of the construction.  The precise details are quite technical, particularly for the law $\x \formaleq (\y \op \y) \op ((\y \op \x) \op \y)$ \eqref{eq1729}, which was the last of the equations whose implications were settled by the ETP.  We refer the reader to the ETP blueprint for further details.
