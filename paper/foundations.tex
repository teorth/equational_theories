\section{Notation and mathematical foundations}\label{notation-sec}

If $\Magma = (M,\op)$ is a magma, we define the left and right multiplication operators $L_a, R_a \colon M \to M$ for $a \in M$ by the formula
\begin{equation}\label{left-right}
    L_x y = R_y x \coloneqq x \op y.
\end{equation}
We also define the squaring operator $S \colon M \to M$ by
\begin{equation}\label{square-def}
    Sx \coloneqq x \op x = L_x x = R_x x.
\end{equation}

A \emph{homomorphism} $f \colon \Magma \to \Magma'$ between two magmas $\Magma = (M,\op)$, $\Magma' = (M',\op')$ is a function $f \colon M \to M'$ such that $f(x \op y) = f(x) \op' f(y)$ for all $x,y \in M$.  An \emph{isomorphism} is a homomorphism that is invertible (which implies that the inverse is also a homomorphism).  An \emph{endomorphism} is a homomorphism from a magma to itself.

If $X$ is an alphabet, we let $\Magma_X = (M_X, \diamond)$ denote the free magma generated by $X$, thus an element of $\Magma_X$ is either a letter in $X$, or of the form\footnote{Strictly speaking, one should use parentheses and write $(w_1 \op w_2)$ to avoid ambiguity, but to reduce clutter we shall abuse notation by omitting parentheses when no ambiguity is caused by doing so.} $w_1 \op w_2$ with $w_1,w_2 \in M_X$.  Every function $f \colon X \to M$ into a magma $\Magma = (M,\op)$ extends to a unique homomorphism $\varphi_f \colon \Magma_X \to \Magma$.  Formally, an equational law with some indeterminates in $X$ can be written as $w_1 \formaleq w_2$ for some $w_1, w_2 \in M_X$; a magma $\Magma = (M,\op)$ then satisfies this law if and only if $\varphi_f(w_1) = \varphi_f(w_2)$ for all $f \colon X \to M$.  We also define the order of a word $w \in M_X$ to be the number of occurrences of $\op$ in the word, thus letters in $X$ are of order $0$, and the order of $w_1 \op w_2$ is the sum of the orders of $w_1, w_2$, plus one.

A \emph{theory} is a collection $\Gamma$ of equational laws; we say that a magma $\Magma$ \emph{satisfies} a theory, and write $\Magma \models \Gamma$, if every law in $\Gamma$ is satisfied by $\Magma$.  If $\E$ is an equational law, we write $\Gamma \models \E$ if every magma that satisfies $\Gamma$ also satisfies $\E$.  A \emph{free magma} $\Magma_{X,\Gamma} = (M_{X,\Gamma},\diamond)$ for such a theory $\Gamma$ and an alphabet $X$ is a magma satisfying $\Gamma$ together with a map $\iota_{X,\Gamma} \colon X \to M_{X,\Gamma}$ which is universal in the sense that every function $f \colon X \to \Magma$ to a magma $\Magma$ satisfying $\Gamma$ uniquely determines a homomorphism $\varphi_{f,\Gamma} \colon \Magma_{X,\Gamma} \to \Magma$ such that $\varphi_{f,\Gamma} \circ \iota_{X,\Gamma} = f$.  This magma is unique up to isomorphism; a canonical way to construct it is as the quotient $\Magma_X/\sim_\Gamma$ of the free magma $\Magma_X$ by the equivalence relation $\sim_\Gamma$ given by declaring $w \sim_\Gamma w'$ if $\Gamma \models w \formaleq w'$ \cite[Theorem 3.5.6]{term-rewriting}.  If $\Gamma = \{\E\}$ consists of a single law $\E$, we write $\Magma_{X,\E}$, $\sim_\E$, $\varphi_{f,\E}$ for $\Magma_{X,\{\E\}}$, $\sim_{\{\E\}}$, $\varphi_{f,\{\E\}}$ respectively.

In general, the free magma $\Magma_{X,\Gamma}$ is difficult to describe in a tractable form, but for some theories, one has a simple description.  We give two simple examples here:

\begin{example}[Commutative and associative free magma]\label{semi-group} The free magma $\Magma_{X,\{\Eq{43}, \Eq{4512}\}}$ for the commutative law $\Eq{43}$ and the associative law $\Eq{4512}$ is the free abelian semigroup generated by $X$ (with $\iota_{X,\{\Eq{43},\Eq{4512}\}}$ the obvious embedding map).
\end{example}

\begin{example}[Left-absorptive free magma]\label{left-absorb}
The free magma $\Magma_{X,\{\Eq{4}\}}$ for the left-absorptive law $\Eq{4}$ is the magma with carrier $X$ and operation $x \op y = x$ (with $\iota_{X,\Eq{4}}$ the identity).
\end{example}


Every magma $\Magma$ has an opposite $\Magma^{\mathrm{op}}$, which has the same carrier but the opposite operation $x \op^{\mathrm{op}} y \coloneqq y \op x$.  A magma $\Magma$ satisfies an equational law $\E$ if and only if its opposite $\Magma^{\mathrm{op}}$ satisfies the dual law $\E^*$, defined by reversing all the operations.  For instance, the dual of
$\x \op \y \formaleq \x \op (\y \op \z)$ \eqref{eq327} is $\y \op \x \formaleq (\z \op \y) \op \x$, which in our numbering system we rewrite in normal form as $\x \op \y \formaleq (\z \op \x) \op \y$ \eqref{eq395}.

We then see that the implication graph has a duality symmetry: given two equational laws $\E_1,\E_2$, we have $\E_1 \models \E_2$ if and only if $\E_1^* \models \E_2^*$.

\section{Formal foundations}


All proofs in the ETP were ultimately formalized in the proof assistant language \emph{Lean}, though in many cases the proofs were first written in an informal human document, which was then incorporated into the human-readable \emph{blueprint}~\cite{leanblueprint} that accompanied the formalization.  Many of the computer-assisted proofs were also first generated as computer output from a source other than \emph{Lean}, such as an ATP, and later converted to a \emph{Lean} proof by a separate program custom-written for this task.

The project relied on \emph{Lean}'s extensive \emph{Mathlib} library, for instance to provide support for algebraic concepts such as the free group that arose in some of the more difficult constructions.  Additional extensions to \emph{Lean}, such as \emph{duper} or \emph{egg}, were employed by some participants in external forks of the repository, but we did not incorporate them into the master repository to simplify the version control process.  As a consequence, some manual translation of proofs produced using such extensions to a proof that avoided such extensions were needed at various stages of the project.

The concept of a magma could be modeled by existing \emph{Mathlib} classes such as \texttt{Mul}; however we chose early in the project to define a custom magma class \texttt{Magma} instead, as for some magma constructions the magma operation (which we denoted $\op$) was distinct from an existing multiplication structure $*$ on the same carrier.  Most components of the \emph{Lean} codebase were placed in namespaces to avoid collisions with each other, and with \emph{Mathlib}.

Equational laws in the project were implemented both syntactically\,---\,as a structure \texttt{LawX} containing two words in a free group\,---\,as well as semantically, as a predicate \texttt{EquationX} that could be applied to a magma. Here \texttt{X} is the number assigned to the law. The semantic formulation (\texttt{EquationX}) was more convenient for proving or refuting specific implications, while the syntactic formulation (\texttt{LawX}) was preferred for implementing metatheorems, such as the use of duality between laws. \emph{Lean}'s metaprogramming features proved to be vital to relate the two representations. A custom command, \texttt{equation}, was created for specifying equational laws. Elaborating the \texttt{equation} command generated both \texttt{EquationX} and \texttt{LawX} definitions from this description, as well as theorems relating them to each other. A similar construction was used to generate dual laws, where the dual law was given explicitly for simplicity.

To facilitate the automatic generation of an implication graph from the \emph{Lean} codebase, a custom \texttt{@{[}equational\_result{]}} tag was formed to attach to propositions in \emph{Lean} to indicate that they were proving or refuting one or more implications; see \Cref{fig:impl}.  A \texttt{conjecture} keyword was also created for implications or refutations which we wished to identify as having an informal proof that had yet to be formalized in \emph{Lean}.

\begin{figure}
\centering
\begin{lean}
@[equational_result]
theorem _root_.Equation1437_not_implies_Equation4269 :
    ∃ (G : Type) (_ : Magma G), Equation1437 G ∧ ¬ Equation4269 G := by
  use ℕ × Fin 3, ⟨op⟩
  constructor
  ⬝ intro x y z
    simp [op, add_assoc]
  ⬝ simp only [not_forall, op]
    use (0, 0), (2, 0)
    decide
\end{lean}
\caption{A sample proof of a formalized implication, in this case that $\Eq{1437} \nmodels \Eq{4269}$.}
\label{fig:impl}
\end{figure}

A single construction of a magma could satisfy multiple laws $\E_1,\E_2,\dots$ and not satisfy others $\E'_1, \E'_2, \dots$, leading to a large number of refutations of the form $\E_i \nmodels \E'_j$.  A custom \texttt{Facts} command was designed to organize such information efficiently; see \Cref{fig:facts}.

\begin{figure}
\centering
\begin{minted}[escapeinside=||]{lean}
@[equational_result]
theorem |\textnormal{\guillemotleft}|Facts from All4x4Tables [[1,2,3,4,5,0],[4,1,2,5,0,3],[3,0,5,2,1,4],
[0,5,4,3,2,1],[5,4,1,0,3,2],[2,3,0,1,4,5]]|\textnormal{\guillemotright}| :
  ∃ (G : Type) (_ : Magma G) (_ : Finite G), Facts G [1316, 2863] [411, 680,
  817, 1020, 1426, 2035, 2441, 2644, 2853, 2855, 2865, 2872, 2947, 3050,
  3253, 3456, 4270, 4283, 4290, 4380, 4598, 4605, 4656] :=
⟨Fin 6, |\textnormal{\guillemotleft}|All4x4Tables [[1,2,3,4,5,0],[4,1,2,5,0,3],[3,0,5,2,1,4],[0,5,4,3,2,1],
[5,4,1,0,3,2],[2,3,0,1,4,5]]|\textnormal{\guillemotright}|, Finite.of_fintype _, by decideFin!⟩
\end{minted}
\caption{A computer generated \texttt{Facts} theorem, using an explicit finite magma of order $6$ to refute several implications at once.}
\label{fig:facts}
\end{figure}

As an additional precaution against ``exploit''-based proofs (such as those that might be contributed by an AI tool) \emph{lean4checker} was used to ensure that no axioms were used in \emph{Lean} outside of a small trusted set.  In particular, \emph{Lean} tactics such as \texttt{native\_decide} that relied on external tools were not permitted into the codebase.

Explicitly formalizing all $\num{22028942}$ implications as theorems would lead to an infeasible compilation time in  \emph{Lean}.  Instead, a reduced generating set of $\num{10657}$ positive implications and $\num{586925}$ negative implications were formalized, with the latter in turn mostly organized into a smaller number of \texttt{Facts} theorems as discussed above.  The extension of these results to the rest of the implication graph via transitivity and duality is currently done by programs external to \emph{Lean}, although in principle one could create an ``end-to-end theorem'' which completely establishes the implication graph within \emph{Lean}.

Some lemmas generated in the project were suitable for upstreaming back to \emph{Mathlib}, as well as several technical improvements to the \emph{LeanBlueprint} software.
