name: Propose PR

on:
  issue_comment:
    types: [created]

jobs:
  propose_pr:
    runs-on: ubuntu-latest

    steps:
    - name: Check if the comment contains "propose PR #PR_NUMBER"
      id: check_propose
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        if [[ "$COMMENT_BODY" =~ propose\ PR\ \#([0-9]+) ]]; then
          PR_NUMBER="${BASH_REMATCH[1]}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_ENV
        else
          echo "The comment does not contain a valid 'propose PR #PR_NUMBER' format."
          exit 0
        fi

    - name: Get issue details
      id: get_issue
      run: |
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} > issue.json
        cat issue.json
      continue-on-error: true

    - name: Check if the commenter is assigned to the issue
      id: check_assignee
      run: |
        COMMENTER="${{ github.event.comment.user.login }}"
        ASSIGNED=$(jq --arg user "$COMMENTER" '.assignees[]?.login | select(. == $user)' issue.json)
        if [ -z "$ASSIGNED" ]; then
          echo "not_assigned=true" >> $GITHUB_ENV
        else
          echo "not_assigned=false" >> $GITHUB_ENV
        fi

    - name: Notify the user if they are not assigned
      if: env.not_assigned == 'true'
      run: |
        echo "User ${{ github.event.comment.user.login }} is not assigned to this issue, exiting."
        exit 0

    - name: Link PR to the issue
      if: env.not_assigned == 'false'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        -d '{"body": "Linking PR #${{ env.pr_number }} to this issue."}' \
        https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments

    - name: Log PR and issue link result
      if: env.not_assigned == 'false'
      run: echo "PR #${{ env.pr_number }} has been successfully linked to issue #${{ github.event.issue.number }}."
